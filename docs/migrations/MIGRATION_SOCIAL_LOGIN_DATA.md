# Migration: Enhanced Social Login Data Storage

**Date:** November 8, 2025  
**Migration Type:** Schema Enhancement (AutoMigrate)  
**Status:** Pending Deployment

## Overview

This migration enhances the user and social account models to store complete profile data from social login providers (Google, Facebook, GitHub). Previously, only basic email information was being stored.

## Changes

### 1. User Model (`pkg/models/user.go`)

**Added Fields:**

| Field Name | Data Type | Description | GORM Tag |
|------------|-----------|-------------|----------|
| `Name` | `string` | Full name from social login or user input | - |
| `FirstName` | `string` | First name from social login | - |
| `LastName` | `string` | Last name from social login | - |
| `ProfilePicture` | `string` | Profile picture URL from social login | - |
| `Locale` | `string` | User's locale/language preference | - |

**Impact:**
- Adds 5 new nullable columns to the `users` table
- No breaking changes to existing data
- Existing users will have empty values for these fields

### 2. Social Account Model (`pkg/models/social_account.go`)

**Added Fields:**

| Field Name | Data Type | Description | GORM Tag |
|------------|-----------|-------------|----------|
| `Email` | `string` | Email from social provider | - |
| `Name` | `string` | Name from social provider | - |
| `FirstName` | `string` | First name from social provider | - |
| `LastName` | `string` | Last name from social provider | - |
| `ProfilePicture` | `string` | Profile picture URL from social provider | - |
| `Username` | `string` | Username/login from social provider (e.g., GitHub login) | - |
| `Locale` | `string` | Locale from social provider | - |
| `RawData` | `datatypes.JSON` | Complete raw JSON data from provider | `gorm:"type:jsonb"` |

**Impact:**
- Adds 8 new columns to the `social_accounts` table
- The `RawData` column is a JSONB field storing the complete provider response
- No breaking changes to existing data
- Existing social accounts will have empty values for these fields

## Data Flow Changes

### Google Login
- **Old Behavior:** Only stored `ID`, `Email`, and `Name` (name was discarded)
- **New Behavior:** Stores `ID`, `Email`, `VerifiedEmail`, `Name`, `GivenName`, `FamilyName`, `Picture`, `Locale`
- **API Call:** Modified to include all available fields
- **Raw Data:** Complete Google user response stored in `RawData`

### Facebook Login
- **Old Behavior:** Only stored `ID`, `Email`, and `Name` (name was discarded)
- **New Behavior:** Stores `ID`, `Email`, `Name`, `FirstName`, `LastName`, `Picture.Data.URL`, `Locale`
- **API Call:** Modified to request extended fields: `id,name,email,first_name,last_name,picture.type(large),locale`
- **Raw Data:** Complete Facebook user response stored in `RawData`

### GitHub Login
- **Old Behavior:** Only stored `ID`, `Login`, and `Email`
- **New Behavior:** Stores `ID`, `Login`, `Email`, `Name`, `AvatarURL`, `Bio`, `Location`, `Company`
- **Raw Data:** Complete GitHub user response stored in `RawData`

## Service Layer Changes

### User Repository (`internal/user/repository.go`)

**Added Method:**
```go
func (r *Repository) UpdateUser(user *models.User) error
```
- Allows updating user profile data when linking social accounts
- Uses GORM's `Save()` method for full model updates

### Social Service (`internal/social/service.go`)

**Enhanced Behavior:**
1. When creating new users via social login:
   - Populate all profile fields from provider data
   - Store complete provider response in `RawData`

2. When linking social account to existing user:
   - Update user profile fields only if currently empty
   - Preserve existing user data if already set
   - Store complete provider response in `RawData`

3. When authenticating existing social account:
   - No changes to existing behavior
   - Social account data remains unchanged

## Database Migration

### Migration Method
- **Type:** GORM AutoMigrate
- **Location:** `internal/database/db.go` - `MigrateDatabase()` function
- **Execution:** Automatic on application startup (line 63 in `cmd/api/main.go`)

### Migration Process
1. When application starts, `database.MigrateDatabase()` is called
2. GORM detects new fields in models
3. Automatically executes ALTER TABLE statements to add new columns
4. All new columns are nullable - no data migration required
5. Existing data remains unchanged

### SQL Operations (Generated by GORM)
```sql
-- Users table
ALTER TABLE users ADD COLUMN name VARCHAR;
ALTER TABLE users ADD COLUMN first_name VARCHAR;
ALTER TABLE users ADD COLUMN last_name VARCHAR;
ALTER TABLE users ADD COLUMN profile_picture VARCHAR;
ALTER TABLE users ADD COLUMN locale VARCHAR;

-- Social Accounts table
ALTER TABLE social_accounts ADD COLUMN email VARCHAR;
ALTER TABLE social_accounts ADD COLUMN name VARCHAR;
ALTER TABLE social_accounts ADD COLUMN first_name VARCHAR;
ALTER TABLE social_accounts ADD COLUMN last_name VARCHAR;
ALTER TABLE social_accounts ADD COLUMN profile_picture VARCHAR;
ALTER TABLE social_accounts ADD COLUMN username VARCHAR;
ALTER TABLE social_accounts ADD COLUMN locale VARCHAR;
ALTER TABLE social_accounts ADD COLUMN raw_data JSONB;
```

## Benefits

1. **Complete Profile Data:** Capture all available user information from social providers
2. **Better User Experience:** Pre-populate user profiles with data from social accounts
3. **Data Provenance:** Track which social provider provided which data
4. **Future-Proof:** `RawData` JSONB field allows accessing any provider-specific fields
5. **Non-Breaking:** Existing users and social accounts remain functional
6. **Flexible:** User profile data can be updated from multiple social providers

## API Impact

### Existing Endpoints - No Breaking Changes
All existing API endpoints continue to work as before. New fields are automatically included in JSON responses:

**GET /profile**
```json
{
  "id": "uuid",
  "email": "user@example.com",
  "email_verified": true,
  "name": "John Doe",
  "first_name": "John",
  "last_name": "Doe",
  "profile_picture": "https://...",
  "locale": "en",
  "two_fa_enabled": false,
  "created_at": "...",
  "updated_at": "...",
  "social_accounts": [...]
}
```

**Social Account Objects**
```json
{
  "id": "uuid",
  "user_id": "uuid",
  "provider": "google",
  "provider_user_id": "...",
  "email": "user@gmail.com",
  "name": "John Doe",
  "first_name": "John",
  "last_name": "Doe",
  "profile_picture": "https://...",
  "username": "",
  "locale": "en",
  "raw_data": {...},
  "expires_at": null,
  "created_at": "...",
  "updated_at": "..."
}
```

## Testing Recommendations

1. **New Social Logins:**
   - Test Google login - verify all fields are populated
   - Test Facebook login - verify all fields are populated
   - Test GitHub login - verify all fields are populated

2. **Existing Social Accounts:**
   - Verify existing social logins still work
   - Verify authentication flow unchanged
   - Check that profile data displays correctly (empty for old accounts)

3. **Account Linking:**
   - Test linking social account to existing email account
   - Verify user profile gets updated with social data
   - Test multiple social accounts for same user

4. **Edge Cases:**
   - Test with providers that don't return optional fields
   - Test with users who have no profile picture
   - Test with private GitHub emails

## Rollback Plan

If issues arise, rollback is simple:

1. Revert code changes to previous commit
2. New columns remain in database (nullable, no impact)
3. Application ignores extra columns
4. No data loss

**Note:** GORM AutoMigrate does NOT delete columns, so rolling back code doesn't remove the new database columns. This is intentional and safe.

## Security Considerations

1. **Sensitive Data:** `RawData` contains complete provider response
   - Marked with `json:"raw_data"` so it's exposed in API responses
   - Consider if this should be `json:"-"` to hide from API responses
   
2. **Profile Pictures:** URLs are stored, not downloaded
   - No local storage of images
   - Links may expire based on provider policies

3. **Email Privacy:** Social provider emails stored separately
   - Useful for tracking data source
   - May differ from user's primary email

## Future Enhancements

1. **Profile Sync:** Add endpoint to refresh profile data from social providers
2. **Picture Upload:** Allow users to override social profile pictures
3. **Privacy Controls:** Let users choose which social data to display
4. **Data Expiration:** Implement refresh logic for stale profile data
5. **Additional Providers:** Easy to extend with new social login providers

## Files Modified

1. `pkg/models/user.go` - Added profile fields
2. `pkg/models/social_account.go` - Added social profile fields and raw data
3. `internal/social/service.go` - Updated all three provider handlers
4. `internal/user/repository.go` - Added `UpdateUser()` method
5. `docs/migrations/MIGRATION_SOCIAL_LOGIN_DATA.md` - This documentation

## Deployment Steps

1. **Code Deployment:**
   ```bash
   git pull origin main
   go mod tidy
   go build -o auth_api cmd/api/main.go
   ```

2. **Application Restart:**
   - Stop current application
   - Start new version
   - GORM AutoMigrate runs automatically
   - Monitor logs for migration success

3. **Verification:**
   ```bash
   # Check database schema
   psql -U [user] -d [dbname] -c "\d users"
   psql -U [user] -d [dbname] -c "\d social_accounts"
   ```

4. **Testing:**
   - Test one social login for each provider
   - Verify profile data is stored
   - Check API response includes new fields

## Related Documentation

- [Phase 3: Social Authentication Integration Plan](../implementation_phases/Phase_3._Social_Authentication_Integration_Plan.md)
- [Database Implementation](../DATABASE_IMPLEMENTATION.md)
- [Security Patterns](../../.cursor/rules/security-patterns.mdc)

