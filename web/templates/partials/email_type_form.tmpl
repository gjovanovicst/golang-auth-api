{{define "email_type_form"}}
<div class="card border-0 shadow-sm border-start border-primary border-3">
    <div class="card-body">
        <h6 class="fw-bold mb-3">
            {{if .IsEdit}}
            <i class="bi bi-pencil me-2"></i>Edit Email Type
            {{else}}
            <i class="bi bi-plus-lg me-2"></i>Add Email Type
            {{end}}
        </h6>
        <form {{if .IsEdit}}
                hx-put="/gui/email-types/{{.ID}}"
              {{else}}
                hx-post="/gui/email-types"
              {{end}}
              hx-target="#email-type-form-container"
              hx-swap="innerHTML">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="etCode" class="form-label small text-muted">Code</label>
                    <input type="text" class="form-control font-monospace" id="etCode" name="code"
                           value="{{.Code}}" placeholder="e.g. CUSTOM_WELCOME"
                           {{if .IsEdit}}disabled{{end}}
                           {{if not .IsEdit}}required{{end}}
                           pattern="[A-Z0-9_]+" title="Uppercase letters, numbers, and underscores only">
                    {{if .IsEdit}}
                    <small class="text-muted">Code cannot be changed after creation.</small>
                    {{end}}
                </div>
                <div class="col-md-3">
                    <label for="etName" class="form-label small text-muted">Name</label>
                    <input type="text" class="form-control" id="etName" name="name"
                           value="{{.Name}}" placeholder="e.g. Custom Welcome Email" required>
                </div>
                <div class="col-md-4">
                    <label for="etSubject" class="form-label small text-muted">Default Subject</label>
                    <input type="text" class="form-control" id="etSubject" name="default_subject"
                           value="{{.DefaultSubject}}" placeholder="e.g. Welcome to our platform!">
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-muted d-block">&nbsp;</label>
                    <div class="form-check form-switch mt-1">
                        <input class="form-check-input" type="checkbox" id="etActive" name="is_active" value="true"
                               {{if .IsActive}}checked{{end}}>
                        <label class="form-check-label small text-muted" for="etActive">Active</label>
                    </div>
                </div>
            </div>
            <div class="row g-3 mt-0">
                <div class="col-12">
                    <label for="etDesc" class="form-label small text-muted">Description</label>
                    <textarea class="form-control" id="etDesc" name="description"
                              rows="2" placeholder="Describe what this email type is used for...">{{.Description}}</textarea>
                </div>
            </div>

            {{if and .IsEdit .IsSystem}}
            <div class="alert alert-info mt-3 mb-0 py-2">
                <i class="bi bi-info-circle me-1"></i>
                <small>This is a system email type. You can update the name, description, subject, and variables, but it cannot be deleted.</small>
            </div>
            {{end}}

            <!-- Dynamic Variables Section -->
            <div class="mt-3">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <label class="form-label small text-muted mb-0">
                        <i class="bi bi-braces me-1"></i>Template Variables
                    </label>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addVariableRow()">
                        <i class="bi bi-plus-lg me-1"></i>Add Variable
                    </button>
                </div>
                <div id="variableRows">
                    {{if .Variables}}
                    {{range $i, $v := .Variables}}
                    <div class="row g-2 mb-2 variable-row">
                        <div class="col-md-3">
                            <input type="text" class="form-control form-control-sm font-monospace" name="var_name[]"
                                   value="{{$v.Name}}" placeholder="variable_name">
                        </div>
                        <div class="col-md-5">
                            <input type="text" class="form-control form-control-sm" name="var_description[]"
                                   value="{{$v.Description}}" placeholder="Variable description">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select form-select-sm" name="var_required[]">
                                <option value="false" {{if not $v.Required}}selected{{end}}>Optional</option>
                                <option value="true" {{if $v.Required}}selected{{end}}>Required</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeVariableRow(this)">
                                <i class="bi bi-trash me-1"></i>Remove
                            </button>
                        </div>
                    </div>
                    {{end}}
                    {{end}}
                </div>
                <p class="text-muted small mb-0 mt-1">
                    <i class="bi bi-info-circle me-1"></i>
                    Variables define placeholders available in email templates for this type (e.g., <code>app_name</code>, <code>user_email</code>).
                </p>
            </div>

            <div class="mt-3 d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg me-1"></i>{{if .IsEdit}}Update{{else}}Create{{end}}
                </button>
                <button type="button" class="btn btn-outline-secondary"
                        hx-get="/gui/email-types/form-cancel"
                        hx-target="#email-type-form-container"
                        hx-swap="innerHTML">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function addVariableRow() {
    var container = document.getElementById('variableRows');
    var row = document.createElement('div');
    row.className = 'row g-2 mb-2 variable-row';
    row.innerHTML = '' +
        '<div class="col-md-3">' +
            '<input type="text" class="form-control form-control-sm font-monospace" name="var_name[]" placeholder="variable_name">' +
        '</div>' +
        '<div class="col-md-5">' +
            '<input type="text" class="form-control form-control-sm" name="var_description[]" placeholder="Variable description">' +
        '</div>' +
        '<div class="col-md-2">' +
            '<select class="form-select form-select-sm" name="var_required[]">' +
                '<option value="false" selected>Optional</option>' +
                '<option value="true">Required</option>' +
            '</select>' +
        '</div>' +
        '<div class="col-md-2">' +
            '<button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeVariableRow(this)">' +
                '<i class="bi bi-trash me-1"></i>Remove' +
            '</button>' +
        '</div>';
    container.appendChild(row);
}

function removeVariableRow(btn) {
    btn.closest('.variable-row').remove();
}
</script>
{{end}}
